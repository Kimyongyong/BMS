close all;clear all;clc;

load chargex.mat;
ts= 1500;                    
Qn = 276;
%soc = SOC/100;
soc = 0:0.025:1;
OCV = 90*[2.766 3.160 3.304 3.353 3.373 3.397 3.430 3.463 3.492 3.518 3.541 3.560 3.577 3.592 3.605 3.618 3.631 3.645 3.661 3.679 3.699 3.724 3.753 3.791 3.823 3.850 3.873 3.895 3.915 3.937 3.961 3.988 4.016 4.044 4.066 4.080 4.090 4.103 4.125 4.168 4.248];
% plot(soc,OCV,".r");
p = polyfit(soc,OCV,8);
%plot(soc,OCV);
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
soc(1)=0.321;          
ocv(1)=polyval(p,soc(1));
for i=2:ts;
    soc(i)=soc(i-1)+I(i)*0.5/(Qn*3600);
    ocv(i)=polyval(p,soc(i));
end

%%RLS????????
%%%y(k)=h1'*cs(k);
%%%%2.1?????????????,????????????????????P0??????????????
cs0=[0.0001 0.0001 0.0001 0.0001 0.0001]';   %?????????
p0=10^(4)*eye(5,5);
%E=10^(-20);                   %????E
cs=[cs0,cs0,zeros(5,ts-2)];           %??????????????
%e=zeros(5,ts);                  %???????????

ff=1;                           %????
T=0.5;                            %????
%2.2?????????????
for k=3:ts;                     %???K 
    ev(k)=ocv(k)-U(k);
    h1=[ev(k-1),ev(k-2),-I(k),-I(k-1),-I(k-2)]';
    q=h1'*p0*h1+ff;            %????1
    q1=inv(q);                 %???K(k)
    k1=p0*h1*q1;               %??K(k)??
    error1(k)=ev(k)-h1'*cs0;      %????????????
    cs1=cs0+k1*error1(k);
    %e1=cs1-cs0;               %???????????????
    %e2=e1./cs0 ;              %????????
    %e(:,k)=e2;                %??????????????????????       
    cs0=cs1;                  %?????????????????
    cs(:,k)=cs1;              %?????c ???????????????? 
    p1=(p0-k1*h1'*p0)/ff;          %?? p(k)??
    p0=p1;                    %??
    %if abs(e2)<=E break;      %??????????????
    %end                       %?????
end                           %?????
cs;                            %???????
%e;                             %???????????
%e2;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%3.
a1=cs(1,1:ts); a2=cs(2,1:ts); a3=cs(3,1:ts); a4=cs(4,1:ts); a5=cs(5,1:ts);
%ea1=e(1,:); ea2=e(2,:);ea3=e(3,:); ea4=e(4,:);ea5=e(5,:); 

%%4.
% R=(a3-a4+a5)/(1+a1-a2);
% ts*tp=T^2*(1+a1-a2)/(4*(1-a1-a2));
% ts+tp=T*(1+a2)/(1-a1-a2);
% R+Rs+Rp=(a3+a4+a5)/(1-a1-a2);
% R*ts+R*tp+Rp*ts+Rs*tp=T*(a3-a5)/(1-a1-a2);
% T?????;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
b0=(a3-a4+a5)./(1+a1-a2);
b1=T*T*(1+a1-a2)./(4*(1-a1-a2));
b2=T*(1+a2)./(1-a1-a2);
b3=(a3+a4+a5)./(1-a1-a2);
b4=T*(a3-a5)./(1-a1-a2);

dd=b2.*b2-4*b1;
tsp=[(b2+sqrt(dd))/2;(b2-sqrt(dd))/2];

R0=b0;
t2=tsp(1,:);
t1=tsp(2,:);
R2=(b4-R0.*t1-b3.*t2)./(t1-t2);
R1=b3-R0-R2;
C2=t2./R2;
C1=t1./R1;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
R00=mean(R0,2);
R11=mean(R1,2);
R22=mean(R2,2);
C11=mean(C1);
C22=mean(C2);
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%5.??????????????    
figure(1)
k=1:ts; 
plot(k,R0)
%axis([1 38569 0 0.04]); % 设置坐标轴在指定的区间

figure(2)
k=1:ts; 
plot(k,R1)
%axis([1 38569 0 1]); % 设置坐标轴在指定的区间

figure(3)
k=1:ts; 
plot(k,R2)
%axis([1 38569 0 0.01]); % 设置坐标轴在指定的区间

figure(4)
k=1:ts; 
plot(k,C1)
%axis([1 15055 0 3000]); % 设置坐标轴在指定的区间

figure(5)
k=1:ts; 
plot(k,C2)
%axis([1 15055 0 1500]); % 设置坐标轴在指定的区间

figure(6)
k=1:ts; 
plot(k,t1)

figure(7)
k=1:ts; 
plot(k,t2)

% figure(8)
% k=1:ts; 
% plot(k,ocv)

I_x = [k' I(1:ts)];
V_x = [k' U(1:ts)];
SOC_x = [k' soc(1:ts)'];
R0_x = [k' R0'];
R1_x = [k' R1'];
R2_x = [k' R2'];
C1_x = [k' C1'];
C2_x = [k' C2'];
OCV_x = [k' ocv'];